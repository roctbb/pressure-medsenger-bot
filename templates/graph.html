<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Графики измерений</title>
</head>
    <!-- Resources -->

    <script src="https://www.amcharts.com/lib/4/core.js"></script>
    <script src="https://www.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/lang/ru_RU.js"></script>
    <script src="https://www.amcharts.com/lib/4/lang/en_US.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
<body>
    <!-- Styles common -->
    <style>
        body {
            font: 90%/160% Arial, Helvetica, sans-serif;
            color: #666;
            width: 900px;
            max-width: 96%;
            margin: 0 auto;
        }
        p {
            margin: 0 0 20px;
        }
        a {
            color: #69C;
            text-decoration: none;
        }
        a:hover {
            color: #F60;
        }
        h1, h2, h3 {
            color: #000;
            line-height: 120%;
            margin: 30px 0 10px;
        }
        h1 {
            font-size: 1.7em;
            color: #000;
        }
        h2 {
            font-size: 1.4em;
            border-top: solid 1px #eee;
            padding-top: 20px;
        }
        h3 {
            font-size: 1.1em;
        }

        .chartdiv-pressure {
            margin-top: 1rem;
            width: 100%;
            height: 800px;
            min-height: 600px;
        }

        .chartdiv {
            margin-top: 1rem;
            width: 100%;
            height: 530px;
        }

        .hidden {
            display: none;
        }

    </style>

    <!-- Styles nav -->
    <style>
        .nav {
            z-index: 100;
            margin: 20px 0;
        }
        .nav ul {
            margin: 0;
            padding: 0;
        }
        .nav li {
            margin: 0 5px 10px 0;
            padding: 0;
            list-style: none;
            display: inline-block;
            *display:inline; /* ie7 */
        }
        .nav a {
            padding: 3px 12px;
            text-decoration: none;
            color: #999;
            line-height: 100%;
        }
        .nav a:hover {
            color: #000;
            cursor: pointer;
        }
        .nav .current a {
            background: #999;
            color: #fff;
            border-radius: 5px;
        }

        /* right nav */
        .nav.right ul {
            text-align: right;
        }

        /* center nav */
        .nav.center ul {
            text-align: center;
        }

        @media screen and (max-width: 600px) {
            .nav {
                position: relative;
                min-height: 40px;
            }
            .nav ul {
                width: 300px;
                padding: 5px 0;
                position: absolute;
                top: 0;
                left: 0;
                border: solid 1px #aaa;
                background: #fff url(https://webdesignerwall.com/demo/responsive-menu/images/icon-menu.png) no-repeat 10px 11px;
                border-radius: 5px;
                box-shadow: 0 1px 2px rgba(0,0,0,.3);
            }
            .nav li {
                display: none; /* hide all <li> items */
                margin: 0;
            }
            .nav .current {
                display: block; /* show only current <li> item */
            }
            .nav a {
                display: block;
                padding: 5px 5px 5px 32px;
                text-align: left;
            }
            .nav .current a {
                background: none;
                color: #666;
            }

            /* on nav hover */
            .nav ul:hover {
                background-image: none;
            }
            .nav ul:hover li {
                display: block;
                margin: 0 0 5px;
            }
            .nav ul:hover .current {
                background: url(https://webdesignerwall.com/demo/responsive-menu/images/icon-check.png) no-repeat 10px 7px;
            }

            /* right nav */
            .nav.right ul {
                left: auto;
                right: 0;
            }

            /* center nav */
            .nav.center ul {
                left: 50%;
                margin-left: -90px;
            }
        }
    </style>

    <!-- HTML -->
    <nav class="nav">
		<ul>
            <li class="current"><a id="all_graph" href="#">Все графики</a></li>
            <li><a id="pressure_graph" href="#">График измерения давления</a></li>
            <li><a id="weight_graph" href="#">График измерения веса</a></li>
            <li><a id="glukose_graph" href="#">График уровеня глюкозы</a></li>
            <li><a id="temperature_graph" href="#">График измерения температуры</a></li>
            <li><a id="pain_button" href="#">График оценки боли</a></li>
            <li><a id="spo2_button" href="#">Насыщение крови кислородом</a></li>
            <li><a id="waist_button" href="#">Окружность талии</a></li>
            <li><a id="shin_button" href="#">Окружность голеней</a></li>

		</ul>
	</nav>

    {% for msg in get_flashed_messages() %}
    <div class="flash">{{msg}}</div>
    {% endfor %}

    <div id="chartdiv_pressure" class="chartdiv-pressure"></div>
    <div id="chartdiv_spo2" class="chartdiv"></div>
    <div id="chartdiv_waist" class="chartdiv"></div>
    <div id="chartdiv_glukose" class="chartdiv"></div>
    <div id="chartdiv_weight" class="chartdiv"></div>
    <div id="chartdiv_temperature" class="chartdiv"></div>
    <div id="chartdiv_pain" class="chartdiv"></div>
    <div id="chartdiv_shin" class="chartdiv"></div>

    <!-- Chart systolic-diastolic-pulse-medicines -->
    <script>
        const Aux = {
            "error": (e) => {
                console.error('error', e)
            },
            "show": (el) => {
                el.classList.remove('hidden')
                el.classList.add('shown')
            },
            "hide": (el) => {
                el.classList.remove('shown')
                el.classList.add('hidden')
            },
            "addClass": (el, nameClass) => {
                el.classList.add(nameClass)
            },
            "removeClass": (el, nameClass) => {
                el.classList.remove(nameClass)
            },
            "removeClassAll": (params, nameClass) => {
                params.forEach((item) => {
                    el = item.parentElement
                    Aux.removeClass(el, nameClass)

                })
            },
            "showAll": (params) => {
                params.forEach((item) => {
                    Aux.show(item)
                })
            },
            "hideAll": (params) => {
                params.forEach((item) => {
                    Aux.hide(item)
                })
            },
            "num": function (param) {
                let num_array = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10']

                if (param < num_array.length) {
                    return num_array[param]
                } else {
                    return param
                }
            },
            "num_day": function (param) {
                let num_array = ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09']

                if (param < num_array.length) {
                    return num_array[param]
                } else {
                    return param
                }
            },
            "dataTransform": function (data) {
                let result = []
                let x = data['x']
                let y = data['y']
                let comments = data['comments']
                let comment = ''

                for (item in x) {
                    let dateOut = x[item]
                    let value_y = y[item]

                    try {
                        comment = comments[item]

                    } catch(e) {
                        comment = ''
                    }

                    let date_format = this.str2date(dateOut)
                    let tooltip_date = this.dateFormat(dateOut)
                    result.push({"comments": comment, "date": dateOut, "dates": dateOut, "dates_format": date_format, "tooltip_date": tooltip_date, "y": value_y})
                }

                return result
            },
            "dateFormat": function(date) {
                let dateOut = new Date(date.replace(' ', 'T'))

                return this.num_day(dateOut.getDate()) + '-' + this.num(dateOut.getMonth()) + '-' + dateOut.getFullYear() + ' ' + this.num(dateOut.getHours()) + ':' + this.num(dateOut.getMinutes())
            },
            "format": function(dateOut) {
                return this.num_day(dateOut.getDate()) + '-' + this.num(dateOut.getMonth()) + '-' + dateOut.getFullYear() + ' ' + this.num(dateOut.getHours()) + ':' + this.num(dateOut.getMinutes())
            },
            "str2date": function(date) {
                return new Date(date.replace(' ', 'T'))
            }
        }

        const namesConstants = {
            "get": function (name) {
                try {
                    return namesConstants[name]
                } catch(e) {
                    Aux.error(e)
                }
            },
            "set": function (name, value) {
                try {
                    namesConstants[name] = value
                    return namesConstants[name]
                } catch(e) {
                    Aux.error(e)
                }
            }
        }

        function dump(data) {
            console.log('dump = ', data)
        }

        /* Create objects */

        const all_graph = document.getElementById('all_graph')
        const pressure_graph = document.getElementById('pressure_graph')
        const weight_graph = document.getElementById('weight_graph')
        const glukose_graph = document.getElementById('glukose_graph')
        const temperature_graph = document.getElementById('temperature_graph')
        const pain_button = document.getElementById('pain_button')
        const spo2_button = document.getElementById('spo2_button')
        const waist_button = document.getElementById('waist_button')
        const shin_button = document.getElementById('shin_button')
        const chartdiv_pressure = document.getElementById('chartdiv_pressure')
        const chartdiv_glukose = document.getElementById('chartdiv_glukose')
        const chartdiv_weight = document.getElementById('chartdiv_weight')
        const chartdiv_temperature = document.getElementById('chartdiv_temperature')
        const theme = document.getElementById('theme')
        const chartdiv_pain = document.getElementById('chartdiv_pain')
        const chartdiv_spo2 = document.getElementById('chartdiv_spo2')
        const chartdiv_waist = document.getElementById('chartdiv_waist')
        const chartdiv_shin = document.getElementById('chartdiv_shin')
        const allDiv = [chartdiv_pressure, chartdiv_glukose, chartdiv_weight, chartdiv_temperature, chartdiv_pain, chartdiv_spo2, chartdiv_waist, chartdiv_shin]
        const allLinks = [all_graph, pressure_graph, weight_graph, glukose_graph, temperature_graph, pain_button, spo2_button, waist_button, shin_button]
        const activeClass = 'current'

        const toggleAll = (divEl, btnEl) => {
            Aux.hideAll(allDiv)
            Aux.show(divEl)
            Aux.removeClassAll(allLinks, activeClass)
            Aux.addClass(btnEl.parentElement, activeClass)
        }

        all_graph.addEventListener('click', (event) => {
            Aux.showAll(allDiv)
            Aux.removeClassAll(allLinks, activeClass)
            Aux.addClass(all_graph.parentElement, activeClass)
        })

        pressure_graph.addEventListener('click', (event) => {
            toggleAll(chartdiv_pressure, pressure_graph)
        })

        weight_graph.addEventListener('click', (event) => {
            toggleAll(chartdiv_weight, weight_graph)
        })

        glukose_graph.addEventListener('click', (event) => {
            toggleAll(chartdiv_glukose, glukose_graph)
        })

        temperature_graph.addEventListener('click', (event) => {
            toggleAll(chartdiv_temperature, temperature_graph)
        })

        pain_button.addEventListener('click', (event) => {
            toggleAll(chartdiv_pain, pain_button)
        })

        spo2_button.addEventListener('click', (event) => {
            toggleAll(chartdiv_spo2, spo2_button)
        })

        waist_button.addEventListener('click', (event) => {
            toggleAll(chartdiv_waist, waist_button)
        })

        shin_button.addEventListener('click', (event) => {
            toggleAll(chartdiv_shin, shin_button)
        })

        const constants = {{ constants | safe }}
        const systolic = {{ systolic | safe }}
        const pain_assessment = {{ pain_assessment | safe }}
        const diastolic = {{ diastolic | safe }}
        const pulse_ = {{ pulse_ | safe }}
        const weight_model = {{ weight | safe }}
        const medicine = {{ medicine | safe }}
        const medicine_trace_data = {{ medicine_trace_data | safe }}

        namesConstants.set('color_pressure_up', 'orange')
        namesConstants.set('color_pressure_down', 'green')
        namesConstants.set('color_pulse', 'blue')
        namesConstants.set('color_danger', 'red')
        namesConstants.set('color_medicine', 'brown')
        namesConstants.set('color_glukose', '#a545c7')
        namesConstants.set('color_weight', 'lightgreen')
        namesConstants.set('color_temperature', '#23759F')

        dump(namesConstants)

        // Create chart instance pressure
        am4core.ready(function() {
            // Vars
            let i = 0
            let data = []
            let dynamic_data = []
            let dynamic_data_x = []
            let dynamic_data_y = []
            let diastolic_value = 0
            let pulse_value = 0
            let date = {}
            let tooltipText = ''
            let bullet_color = ''
            let systolic_up_color = ''
            let systolic_down_color = ''
            let diastolic_up_color = ''
            let diastolic_down_color = ''
            let pulse_up_color = ''
            let pulse_down_color = ''

            systolic['disabled_systolic'] = true

            let disabled_diastolic = true
            let disabled_pulse = true
            {#let disabled_glukose = true#}
            let systolic_dates = systolic['x']
            let systolic_values = systolic['y']
            let systolic_comments = systolic['comments']
            {#let diastolic_dates = diastolic['x']#}
            let diastolic_values = diastolic['y']
            {#let pulse_dates = pulse_['x']#}
            let pulse_values = pulse_['y']
            let medicine_x = medicine['x']
            {#let medicine_dates = ''#}
            let systolic_value = ''
            {#let pain_value = ''#}
            {#let comment = ''#}
            {#let medicine_y = 20#}
            {#let medicine_text = medicine['text']#}
            {#let medicine_amount = medicine['amount']#}
            {#let config = {}#}

            if (medicine_x.length > 0 && systolic_dates.length == 0) {
                systolic_dates = medicine_x
            }

            let dates_medicines = []
            let data_ = {}
            let date_in = ''
            let _y = 2
            let series_name = ''
            let dosage = ''
            let amount = ''
            let data_medicines_out = []
            let color_index = 0
            let medicine_colors = ["brown", "#536A56", "#91690D", "#DBD41A", "#B9ACAC", "#077317", "#072173", "#B35EBA", "#2F4892", "#840D91"]

            am4core.useTheme(am4themes_animated)
            let chart = am4core.create("chartdiv_pressure", am4charts.XYChart)
            chart.dateFormatter.inputDateFormat = "YYYY-MM-DD HH:NN:SS"
            chart.language.locale = am4lang_ru_RU

            // Create axes
            axis = new am4charts.DateAxis()
            axis.dateFormats.setKey("day", "dd.MM")
            axis.dateFormats.setKey("week", "dd.MM")
            axis.dateFormats.setKey("month", "MM.yyyy")

            let categoryAxis = chart.xAxes.push(axis)
            categoryAxis.renderer.grid.template.location = 0

            let valueAxis = chart.yAxes.push(new am4charts.ValueAxis())
            let dateOut = ''
            let date_tooltip = ''

            let systolic_normal = 0

            valueAxis.renderer.minGridDistance = 10

            // Add data
            systolic_dates.forEach(function() {
                systolic_value = systolic_values[i]
                diastolic_value = diastolic_values[i]
                pulse_value = pulse_values[i]
                comment = systolic_comments[i]

                // 2

                if (systolic_value >= constants.max_systolic || systolic_value < constants.min_systolic) {
                    systolic_up_color = namesConstants.get('color_danger')
                    systolic['disabled_systolic'] = false
                } else {
                    systolic_up_color = namesConstants.get('color_pressure_up')
                    systolic['disabled_systolic'] = true
                }

                if (diastolic_value >= constants.max_diastolic || diastolic_value < constants.min_diastolic) {
                    diastolic_down_color = namesConstants.get('color_danger')
                    disabled_diastolic = false
                } else {
                    diastolic_down_color = namesConstants.get('color_pressure_down')
                    disabled_diastolic = true
                }

                if (pulse_value >= constants.max_pulse || pulse_value < constants.min_pulse) {
                    pulse_up_color = namesConstants.get('color_danger')
                    disabled_pulse = false
                } else {
                    pulse_up_color = namesConstants.get('color_pulse')
                    disabled_pulse = true
                }

                dateOut = new Date(systolic_dates[i].replace(' ', 'T'))
                date_tooltip = Aux.format(dateOut)

                if (i == 0) {
                    dynamic_data_x.push(dateOut)
                    dynamic_data_y.push(systolic_dates.length)
                }

                if (i > 0 && systolic_value < constants.max_systolic) {
                    systolic_normal++
                    dynamic_data_x.push(dateOut)
                    dynamic_data_y.push(i/systolic_normal)
                }

                data[i] = {
                    systolic_pressure: systolic_value,
                    diastolic_pressure: diastolic_value,
                    comment: comment,
                    pulse_value: pulse_value,
                    date: dateOut,
                    date_tooltip: date_tooltip,
                    max_systolic: constants.max_systolic,
                    min_diastolic: constants.min_diastolic,
                    max_pulse: constants.max_pulse,
                    systolic_up_color: systolic_up_color,
                    diastolic_down_color: diastolic_down_color,
                    pulse_up_color: pulse_up_color,
                    disabled_systolic: systolic['disabled_systolic'],
                    disabled_diastolic: disabled_diastolic,
                    disabled_pulse: disabled_pulse
                }
                i++
            })

            data[data.length+1] = {
                date: new Date()
            }

            dynamic_data['x'] = dynamic_data_x
            dynamic_data['y'] = dynamic_data_y
            dynamic_data['name'] = 'Динамика роста давления'
            chart.data = data.reverse();

            let date_max = new Date(systolic['date_max'].replace(' ', 'T'))
            let date_min = new Date(systolic['date_min'].replace(' ', 'T'))
            let zoomToDates = systolic['zoomToDates']

            if (zoomToDates == 'on') {
                chart.events.on("ready", function () {
                    categoryAxis.zoomToDates(
                        date_min,
                        date_max
                    );
                });
            }

            // Create series Medicine
            function createSeriesMedicine(field, data, series_name, color, config) {
                let series = chart.series.push(new am4charts.LineSeries());
                series.dataFields.valueY = field
                series.dataFields.dateX = "date_out"
                series.dataFields.value = "name"
                series.name = series_name
                series.strokeOpacity = 0
                series.data = data


                let bullet = series.bullets.push(new am4charts.Bullet())
                let square = bullet.createChild(am4core.Rectangle)
                square.width = 12
                square.height = 12
                square.horizontalCenter = "middle"
                square.verticalCenter = "middle"

                bullet.fill = am4core.color(color)
                bullet.strokeOpacity = 0
                bullet.radius = 5
                bullet.fillOpacity = 0.7

                bullet.tooltipText = "{name} | {dosage} {amount} | время приема: {date_tooltip}"

                let hoverState = bullet.states.create("hover")
                hoverState.properties.fillOpacity = 1
                hoverState.properties.strokeOpacity = 1

                series.heatRules.push({ target: bullet, min: 2, max: 17, property: "radius" })
                chart.scrollbarX = new am4core.Scrollbar()
            }

            for (key in medicine_trace_data) {
                data_ = medicine_trace_data[key]
                dosage = data_.dosage
                amount = data_.amount
                dates_medicines = data_.medicines_times_
                series_name = key
                data_medicines_out = []

                for (item in dates_medicines) {
                    date_in = new Date(dates_medicines[item].replace(' ', 'T'))
                    date_tooltip = Aux.format(date_in)
                    data_medicines_out.push({"date_tooltip": date_tooltip, "date_out": date_in, "Y": _y, "series_name": series_name, "name": series_name, "dosage": dosage, "amount": amount})

                }

                if (data_medicines_out.length > 0) {
                    createSeriesMedicine('Y', data_medicines_out, series_name, medicine_colors[color_index])
                }

                _y += 3
                color_index++
            }

            // Creation series function for Pressure
            function createSeries(field, name, config, data) {
                {#chart.dataSource.reloadFrequency = 5000;#}
                {#chart.dataSource.incremental = true;#}
                let series = chart.series.push(new am4charts.LineSeries());
                series.groupData = false;

                series.dataFields.valueY = field;
                series.dataFields.dateX = "date";
                series.name = name;
                series.tooltipText = config.tooltipText;
                series.strokeWidth = 2
                series.propertyFields.stroke = "color";
                series.stroke = am4core.color(config.color);
                series.strokeDasharray = "3,3"

                chart.scrollbarX = new am4core.Scrollbar();

                let circleBullet = series.bullets.push(new am4charts.CircleBullet());
                circleBullet.circle.stroke = am4core.color(config.color);
                circleBullet.circle.strokeWidth = 2;
                circleBullet.tooltipText = config.tooltipText;

                let bullet = series.bullets.push(new am4charts.CircleBullet());
                bullet.circle.stroke = am4core.color("#f00");
                bullet.circle.strokeWidth = 2;
                bullet.circle.zindex = 10;

                chart.fontSize = 9;

                let latitudeLabel = series.bullets.push(new am4charts.LabelBullet());
                latitudeLabel.label.text = config.value;
                latitudeLabel.label.dx = 0;
                latitudeLabel.label.dy = -15;

                if (name == systolic.name) {
                    bullet.disabled = true;
                    bullet.propertyFields.disabled = "disabled_systolic";
                }

                if (name == diastolic.name) {
                    bullet.disabled = true;
                    bullet.propertyFields.disabled = "disabled_diastolic";
                }

                if (name == pulse_.name) {
                    bullet.disabled = true;
                    bullet.propertyFields.disabled = "disabled_pulse";
                }

            }

            tooltipText = "Верхнее давление: [bold]{systolic_pressure}[normal] " + " | до " + constants.max_systolic + " | {date_tooltip}" + "\n {comment}"

            config = {
                "color": namesConstants.get('color_pressure_up'),
                "tooltipText": tooltipText,
                "value": "{systolic_pressure}"
            }

            createSeries("systolic_pressure", systolic.name, config)

            tooltipText = "Нижнее давление: [bold]{diastolic_pressure}[normal]" + " | до " + constants.max_diastolic + " | {date_tooltip}"

            config = {
                "color": namesConstants.get('color_pressure_down'),
                "tooltipText": tooltipText,
                "value": "{diastolic_pressure}"
            }

            createSeries("diastolic_pressure", diastolic.name, config)

            tooltipText = "Пульс: [bold]{pulse_value}[normal] | от " + constants.min_pulse + " до " + constants.max_pulse + " | " + " {date_tooltip}"

            config = {
                "color": namesConstants.get('color_pulse'),
                "tooltipText": tooltipText,
                "value": "{pulse_value}"
            }

            createSeries("pulse_value", pulse_.name, config);

            chart.legend = new am4charts.Legend();
            chart.cursor = new am4charts.XYCursor()
            chart.cursor.behavior = "panXY"

            // Enable export
            chart.exporting.menu = new am4core.ExportMenu()
            chart.exporting.menu.verticalAlign = "bottom";


            })

        //  ************************************* END am4core.ready()

    </script>

    <!-- Chart pain -->
    <script>
        am4core_pain = am4core
        am4charts_pain = am4charts

        am4core_pain.ready(function() {
            delta_y = 11
            dates_medicines = []
            data_ = {}
            date_in = ''
            series_name = ''
            dosage = ''
            amount = ''
            data_medicines_out = []
            color_index = 0
            medicine_colors = ["brown", "#536A56", "#91690D", "#DBD41A", "#B9ACAC", "#077317", "#072173", "#B35EBA", "#2F4892", "#840D91"]

            // ******* START pain_dates.forEach

            iterator_pain_dates = 0
            data_pain = []
            pain_dates = pain_assessment['x']
            pain_values = pain_assessment['y']
            pain_comments = pain_assessment['comments']
            pain_value = ''
            pain_y = 0
            disabled_pain = false

            pain_dates.forEach(function() {
                pain_value = pain_values[iterator_pain_dates]
                pain_y = pain_values[iterator_pain_dates]

                if (pain_value == 0) {
                    pain_value = pain_value + " баллов"
                }

                if (pain_value == 1) {
                    pain_value = pain_value + " балл"
                }

                if (pain_value > 1 && pain_value < 5) {
                    pain_value = pain_value + " балла"
                }

                if (pain_value > 4) {
                    pain_value = pain_value + " баллов"
                }

                pain_comment = pain_comments[iterator_pain_dates]

                pain_dateOut = new Date(pain_dates[iterator_pain_dates].replace(' ', 'T'))
                pain_date_tooltip = Aux.format(pain_dateOut)

                if (pain_y >= constants.max_pain || pain_y < constants.min_pain) {
                    pain_up_color = "red"
                    disabled_pain = false
                } else {
                    pain_up_color = "brown"
                    disabled_pain = true
                }

                if (pain_y == 10) {
                    disabled_pain = true
                }

                data_pain[iterator_pain_dates] = {
                    pain_value: pain_y,
                    pain_comment: pain_comment,
                    pain_date: pain_dateOut,
                    pain_date_tooltip: pain_date_tooltip,
                    max_pain: constants.max_pain,
                    min_pain: constants.min_pain,


                    disabled_pain: disabled_pain,
                }

                iterator_pain_dates++
            })

            // *********************************************
            // ******* Create chart instance pain_assessment
            // *********************************************

            am4core_pain.useTheme(am4themes_animated)

            let chart_pain = am4core_pain.create("chartdiv_pain", am4charts_pain.XYChart)
            chart_pain.language.locale = am4lang_ru_RU

            // Create axes
            let categoryAxis_pain = chart_pain.xAxes.push(new am4charts_pain.DateAxis())
            categoryAxis_pain.dateFormats.setKey("day", "dd.MM")
            categoryAxis_pain.dateFormats.setKey("week", "dd.MM")
            categoryAxis_pain.dateFormats.setKey("month", "MM.yyyy")
            categoryAxis_pain.renderer.grid.template.location = 0

            let valueAxis_pain = chart_pain.yAxes.push(new am4charts_pain.ValueAxis())


            valueAxis_pain.renderer.minGridDistance = 50

            chart_pain.data = data_pain.reverse()

            let date_max = new Date(pain_assessment['date_max'].replace(' ', 'T'))
            let date_min = new Date(pain_assessment['date_min'].replace(' ', 'T'));

            // Pre-zoom the chart
            chart_pain.events.on("ready", function () {
                categoryAxis_pain.zoomToDates(
                    date_min,
                    date_max
                );
            });

            image_width_pain = 9

            // Create series for pain_assessment
            function createSeriesPain(field, name, config) {
                let series_pain = chart_pain.series.push(new am4charts_pain.LineSeries());
                // 1-й параметр - значение по оси x
                series_pain.dataFields.valueY = field;

                // 2-й параметр - значение по оси y
                series_pain.dataFields.dateX = "pain_date";
                series_pain.name = name;
                series_pain.tooltipText = config.tooltipText;
                series_pain.strokeWidth = 2;
                series_pain.propertyFields.stroke = "color"
                series_pain.stroke = am4core_pain.color(config.color)
                series_pain.strokeDasharray = "3,3"



                let circleBullet = series_pain.bullets.push(new am4charts_pain.CircleBullet());
                circleBullet.circle.stroke = am4core.color(config.color);
                circleBullet.circle.strokeWidth = 2;
                circleBullet.tooltipText = config.tooltipText;

                let bullet = series_pain.bullets.push(new am4charts.CircleBullet());
                bullet.circle.stroke = am4core.color("#f00");
                bullet.circle.strokeWidth = 2;
                bullet.circle.zindex = 10;

                bullet.disabled = true
                bullet.propertyFields.disabled = "disabled_pain"

                bullet.tooltipText = config.tooltipText
                chart_pain.scrollbarX = new am4core_pain.Scrollbar()

                chart.fontSize = 9;

                let latitudeLabel = series_pain.bullets.push(new am4charts_pain.LabelBullet());
                latitudeLabel.label.text = "{pain_value}";
                latitudeLabel.label.dx = 0;
                latitudeLabel.label.dy = -15;
            }

            tooltipText = "{pain_date_tooltip} | {pain_value} | {pain_comment}"

            config = {
                "color": "green",
                "tooltipText": tooltipText
            }

            // 1-й параметр - значение по оси x
            createSeriesPain("pain_value", 'Оценка боли', config)

            // ***************************************
            // ******* Create chart instance medicines
            // ***************************************

            // Create series for medicine
            function createSeriesMedicine(field, data, series_name, color, config) {
                let series_medicine = chart_pain.series.push(new am4charts_pain.LineSeries());
                series_medicine.dataFields.valueY = field
                series_medicine.dataFields.dateX = "date_out"
                series_medicine.dataFields.value = "name"
                series_medicine.name = series_name




                series_medicine.strokeOpacity = 0

                series_medicine.data = data



                let bullet_medicine = series_medicine.bullets.push(new am4charts_pain.Bullet())
                let square = bullet_medicine.createChild(am4core.Rectangle)
                square.width = 12
                square.height = 12
                square.horizontalCenter = "middle"
                square.verticalCenter = "middle"

                bullet_medicine.fill = am4core_pain.color(color)
                bullet_medicine.strokeOpacity = 0
                bullet_medicine.radius = 5
                bullet_medicine.fillOpacity = 0.7



                bullet_medicine.tooltipText = "{name} | {dosage} {amount} | время приема: {date_tooltip}"

                let hoverState = bullet_medicine.states.create("hover")
                hoverState.properties.fillOpacity = 1
                hoverState.properties.strokeOpacity = 1

                series_medicine.heatRules.push({ target: bullet_medicine, min: 2, max: 17, property: "radius" })
                chart_pain.scrollbarX = new am4core_pain.Scrollbar()
            }

            for (key in medicine_trace_data) {
                data_ = medicine_trace_data[key]
                dosage = data_.dosage
                amount = data_.amount
                dates_medicines = data_.medicines_times_
                series_name = key
                data_medicines_out = []

                for (item in dates_medicines) {
                    date_in = new Date(dates_medicines[item].replace(' ', 'T'))
                    date_tooltip = Aux.format(date_in)
                    data_medicines_out.push({"date_tooltip": date_tooltip, "date_out": date_in, "Y": delta_y, "series_name": series_name, "name": series_name, "dosage": dosage, "amount": amount})

                }

                if (data_medicines_out.length > 0) {
                    createSeriesMedicine('Y', data_medicines_out, series_name, medicine_colors[color_index])
                }

                delta_y += 3
                color_index++
            }

            // *********************************************

            chart_pain.legend = new am4charts_pain.Legend();
            chart_pain.cursor = new am4charts_pain.XYCursor();
            chart_pain.cursor.behavior = "panXY"

            // Enable export
            chart_pain.exporting.menu = new am4core_pain.ExportMenu()
            chart_pain.exporting.menu.verticalAlign = "bottom";

            // End *******

        })
    </script>

    <script>
        let model = {}
        let am4Core = {
            "get": function (name) {
                try {
                    return namesConstants[name]
                } catch(e) {
                    Aux.error(e)
                }
            },
            "set": function (name, value) {
                try {
                    namesConstants[name] = value
                    return namesConstants[name]
                } catch(e) {
                    Aux.error(e)
                }
            },
            "darkTheme": function (obj) {
                try {
                    obj.useTheme(am4themes_dark)
                    obj.useTheme(am4themes_animated)
                } catch(e) {
                    Aux.error(e)
                }
            },
            "defaultTheme": function (obj) {
                try {
                    obj.useTheme(am4themes_animated)
                } catch(e) {
                    Aux.error(e)
                }
            },
            "makeGraph": function(params) {
                chart = am4core.create(params.div, am4charts.XYChart)
                chart.language.locale = params.lang
                dateAxis = chart.xAxes.push(new am4charts.DateAxis())
                dateAxis.dateFormats.setKey("day", "dd.MM")
                dateAxis.dateFormats.setKey("week", "dd.MM")
                dateAxis.dateFormats.setKey("month", "MM.yyyy")
                dateAxis.renderer.grid.template.location = params.location

                let date_max = new Date(params.model['date_max'].replace(' ', 'T'))
                let date_min = new Date(params.model['date_min'].replace(' ', 'T'));

                // Pre-zoom the chart
                chart.events.on("ready", function () {
                    dateAxis.zoomToDates(
                        date_min,
                        date_max
                    );
                });

                yAxis = chart.yAxes.push(new am4charts.ValueAxis())
                yAxis.min = params.y_min
                yAxis.max = params.y_max
                yAxis.minGridDistance = 10
                model = params.model
                data = Aux.dataTransform(model)
                data = data.reverse()
                min = params.min
                max = params.max

                for (key in data) {
                    if (data[key]['y'] > max || data[key]['y'] < min) {
                        data[key]['color_danger'] = namesConstants.get('color_danger')
                        data[key]['disabled'] = false
                    } else {
                        data[key]['disabled'] = true
                    }
                }

                tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}"

                config = {
                    "name": model.name,
                    "field": "y",
                    "dateX": "dates_format",
                    "comments": "comments",
                    "tooltipText": tooltipText,
                    "color": params.color,
                    "color_danger": "color_danger",
                    "strokeWidth": params.strokeWidth,
                    "disabled": "disabled",
                    "chart": chart
                }



                am4Core.createSeries(data, config)

                // Create legend
                chart.legend = new am4charts.Legend()

                // Create cursor
                chart.cursor = new am4charts.XYCursor()
                chart.cursor.behavior = "panXY"


                // Enable export
                chart.exporting.menu = new am4core.ExportMenu()
                chart.exporting.menu.verticalAlign = "bottom";
            },
            "createSeries": function(data, config) {
                let series = config.chart.series.push(new am4charts.LineSeries())
                config.chart.scrollbarX = new am4core.Scrollbar()
                config.chart.fontSize = 9;
                series.dataFields.valueY = config.field

                series.dataFields.dateX = config.dateX
                series.dataFields.comments = config.comments
                series.name = config.name

                series.tooltipText = config.tooltipText
                series.strokeWidth = config.strokeWidth
                series.stroke = config.color
                series.strokeDasharray = "3,3"
                series.data = data

                let circleBullet = series.bullets.push(new am4charts_pain.CircleBullet());
                circleBullet.circle.stroke = am4core.color(config.color);
                circleBullet.circle.strokeWidth = 2;
                circleBullet.tooltipText = config.tooltipText;

                let bullet = series.bullets.push(new am4charts.CircleBullet());
                bullet.circle.stroke = am4core.color("#f00");
                bullet.circle.strokeWidth = 2;
                bullet.circle.zindex = 10;

                bullet.disabled = "disabled";
                bullet.propertyFields.disabled = config.disabled;

                let latitudeLabel = series.bullets.push(new am4charts.LabelBullet());
                latitudeLabel.label.text = config.value;
                latitudeLabel.label.dx = 0;
                latitudeLabel.label.dy = -15;

                return series;
            }
        }

        am4Core.defaultTheme(am4core)

        let strokeWidth = 2
        let date_max;
        let date_min;

        // ************************************
        // ******* Create chart instance shin
        // ************************************

        shin_left = {{ shin_left | safe }};
        shin_right = {{ shin_right | safe }};

        let chart = am4core.create("chartdiv_shin", am4charts.XYChart);
        chart.scrollbarX = new am4core.Scrollbar()
        chart.language.locale = am4lang_ru_RU;

        shinData = [];

        i = 0
        shin_left.x.forEach(function(date) {
            shinData.push({'date': new Date(date.replace(' ', 'T')), 'value1': shin_left.y[i], 'value2': shin_right.y[i], 'previousDate': new Date(shin_right.x[i].replace(' ', 'T'))});
            i++
        })

        // Add data
        chart.data = shinData.reverse()

        // Create axes
        let dateAxis = chart.xAxes.push(new am4charts.DateAxis());
        dateAxis.dateFormats.setKey("day", "dd.MM")
        dateAxis.dateFormats.setKey("week", "dd.MM")
        dateAxis.dateFormats.setKey("month", "MM.yyyy")
        dateAxis.renderer.minGridDistance = 50;

        date_max = new Date(shin_left['date_max'].replace(' ', 'T'))
        date_min = new Date(shin_left['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart.events.on("ready", function () {
            dateAxis.zoomToDates(
                date_min,
                date_max
            );
        });

        let valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

        // Create series
        let series = chart.series.push(new am4charts.LineSeries());
        series.dataFields.valueY = "value1";
        series.dataFields.dateX = "date";
        series.strokeWidth = 2;
        series.strokeDasharray = "3,4";
        series.tooltipText = "Объем левой голени: [bold]{value1}[/] см | {date.formatDate('dd-MM-yyyy k:mm')}\nОбъем правой голени: [bold]{value2}[/] см | {previousDate.formatDate('dd-MM-yyyy k:mm')}";
        series.tooltip.pointerOrientation = "vertical";
        series.name = 'Обхват голени';

        chart.fontSize = 9;

        let latitudeLabel = series.bullets.push(new am4charts.LabelBullet());
        latitudeLabel.label.text = "{value1}";
        latitudeLabel.label.dx = 0;
        latitudeLabel.label.dy = -10;

        // Create series
        let series2 = chart.series.push(new am4charts.LineSeries());
        series2.dataFields.valueY = "value2";
        series2.dataFields.dateX = "date";
        series2.strokeWidth = 2;
        series2.strokeDasharray = "3,3";
        series2.stroke = series.stroke;

        let latitudeLabel2 = series2.bullets.push(new am4charts.LabelBullet());
        latitudeLabel2.label.text = "{value2}";
        latitudeLabel2.label.dx = 0;
        latitudeLabel2.label.dy = -10;

        // Create legend
        chart.legend = new am4charts.Legend()

        // Add cursor
        chart.cursor = new am4charts.XYCursor();
        chart.cursor.behavior = "panXY"
        chart.cursor.xAxis = dateAxis;

        // Enable export
        chart.exporting.menu = new am4core.ExportMenu()
        chart.exporting.menu.verticalAlign = "bottom";

        // ************************************
        // ******* Create chart instance waist
        // ************************************

        model = {{ waist | safe }}
        model['min'] = constants.min_waist
        model['max'] = constants.max_waist

        model['name'] = 'Окружность талии'

        params = {
            "div": "chartdiv_waist",
            "lang": am4lang_ru_RU,
            "location": 0,
            "distance": 100,
            "y_min": 0,
            "y_max": 200,
            "min": model.min,
            "max": model.max,
            "color": "#2f2f1e",
            "strokeWidth": strokeWidth,
            "comments": model.comments,
            "model": model
        }




        chart_waist = am4core.create(params.div, am4charts.XYChart)
        chart_waist.language.locale = params.lang
        dateAxis_waist = chart_waist.xAxes.push(new am4charts.DateAxis())
        dateAxis_waist.renderer.grid.template.location = params.location
        dateAxis_waist.dateFormats.setKey("day", "dd.MM")
        dateAxis_waist.dateFormats.setKey("week", "dd.MM")
        dateAxis_waist.dateFormats.setKey("month", "MM.yyyy")




        date_max = new Date(params.model['date_max'].replace(' ', 'T'))
        date_min = new Date(params.model['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart_waist.events.on("ready", function () {
            dateAxis_waist.zoomToDates(
                date_min,
                date_max
            );
        });

        yAxis_waist = chart_waist.yAxes.push(new am4charts.ValueAxis())
        yAxis_waist.min = params.y_min
        yAxis_waist.max = params.y_max
        model = params.model
        data = Aux.dataTransform(model)
        data = data.reverse()
        min = params.min
        max = params.max

        for (key in data) {
            if (data[key]['y'] > max || data[key]['y'] < min) {
                data[key]['color_danger'] = namesConstants.get('color_danger')
                data[key]['disabled'] = false
            } else {
                data[key]['disabled'] = true
            }
        }

        tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}"

        config = {
            "name": model.name,
            "field": "y",
            "dateX": "dates_format",
            "comments": "comments",
            "tooltipText": tooltipText,
            "color": params.color,
            "color_danger": "color_danger",
            "strokeWidth": params.strokeWidth,
            "disabled": "disabled",
            "chart": chart_waist,
            "value": "{y}"
        }


        // Обхват талии
        am4Core.createSeries(data, config)

        // Create legend
        chart_waist.legend = new am4charts.Legend()

        // Create cursor
        chart_waist.cursor = new am4charts.XYCursor()
        chart_waist.cursor.behavior = "panXY"

        // Enable export
        chart_waist.exporting.menu = new am4core.ExportMenu()
        chart_waist.exporting.menu.verticalAlign = "bottom";


        // ************************************
        // ******* Create chart instance spo2
        // ************************************

        model = {{ spo2 | safe }}
        model['min'] = constants.min_spo2
        model['max'] = constants.max_spo2

        model['name'] = 'Насыщение крови кислородом'

        params = {
            "div": "chartdiv_spo2",
            "lang": am4lang_ru_RU,
            "location": 0,
            "distance": 100,
            "y_min": 0,
            "y_max": 120,
            "min": model.min,
            "max": model.max,
            "color": "brown",
            "strokeWidth": strokeWidth,
            "comments": model.comments,
            "model": model
        }

        //am4Core.makeGraph(params)

        chart_spo2 = am4core.create(params.div, am4charts.XYChart)
        chart_spo2.language.locale = params.lang
        dateAxis_spo2 = chart_spo2.xAxes.push(new am4charts.DateAxis())
        dateAxis_spo2.renderer.grid.template.location = params.location
        dateAxis_spo2.dateFormats.setKey("day", "dd.MM")
        dateAxis_spo2.dateFormats.setKey("week", "dd.MM")
        dateAxis_spo2.dateFormats.setKey("month", "MM.yyyy")


        date_max = new Date(params.model['date_max'].replace(' ', 'T'))
        date_min = new Date(params.model['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart_spo2.events.on("ready", function () {
            dateAxis_spo2.zoomToDates(
                date_min,
                date_max
            );
        });

        yAxis_spo2 = chart_spo2.yAxes.push(new am4charts.ValueAxis())
        yAxis_spo2.min = params.y_min
        yAxis_spo2.max = params.y_max
        model = params.model
        data = Aux.dataTransform(model)
        data = data.reverse()
        min = params.min
        max = params.max

        for (key in data) {
            if (data[key]['y'] > max || data[key]['y'] < min) {
                data[key]['color_danger'] = namesConstants.get('color_danger')
                data[key]['disabled'] = false
            } else {
                data[key]['disabled'] = true
            }
        }

        tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}"

        config = {
            "name": model.name,
            "field": "y",
            "dateX": "dates_format",
            "comments": "comments",
            "tooltipText": tooltipText,
            "color": params.color,
            "color_danger": "color_danger",
            "strokeWidth": params.strokeWidth,
            "disabled": "disabled",
            "chart": chart_spo2,
            "value": "{y}"
        }



        am4Core.createSeries(data, config)

        // Create legend
        chart_spo2.legend = new am4charts.Legend()

        // Create cursor
        chart_spo2.cursor = new am4charts.XYCursor()
        chart_spo2.cursor.behavior = "panXY"

        // Enable export
        chart_spo2.exporting.menu = new am4core.ExportMenu()
        chart_spo2.exporting.menu.verticalAlign = "bottom";

        // *****************************************
        // ******* Create chart instance temperature
        // *****************************************

        model = {{ temperature | safe }}
        model['min'] = constants.min_temperature
        model['max'] = constants.max_temperature


        params = {
            "div": "chartdiv_temperature",
            "lang": am4lang_ru_RU,
            "location": 0,
            "distance": 100,
            "y_min": 28,
            "y_max": 44,
            "min": model.min,
            "max": model.max,
            "color": "#23759F",
            "strokeWidth": strokeWidth,
            "model": model
        }



        chart_temperature = am4core.create(params.div, am4charts.XYChart)
        chart_temperature.language.locale = params.lang
        dateAxis_temperature = chart_temperature.xAxes.push(new am4charts.DateAxis())
        dateAxis_temperature.renderer.grid.template.location = params.location
        dateAxis_temperature.dateFormats.setKey("day", "dd.MM")
        dateAxis_temperature.dateFormats.setKey("week", "dd.MM")
        dateAxis_temperature.dateFormats.setKey("month", "MM.yyyy")


        date_max = new Date(params.model['date_max'].replace(' ', 'T'))
        date_min = new Date(params.model['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart_temperature.events.on("ready", function () {
            dateAxis_temperature.zoomToDates(
                date_min,
                date_max
            );
        });

        yAxis_temperature = chart_temperature.yAxes.push(new am4charts.ValueAxis())
        yAxis_temperature.min = params.y_min
        yAxis_temperature.max = params.y_max
        model = params.model
        data = Aux.dataTransform(model)
        data = data.reverse()
        min = params.min
        max = params.max

        for (key in data) {
            if (data[key]['y'] > max || data[key]['y'] < min) {
                data[key]['color_danger'] = namesConstants.get('color_danger')
                data[key]['disabled'] = false
            } else {
                data[key]['disabled'] = true
            }
        }

        tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}"

        config = {
            "name": model.name,
            "field": "y",
            "dateX": "dates_format",
            "comments": "comments",
            "tooltipText": tooltipText,
            "color": params.color,
            "color_danger": "color_danger",
            "strokeWidth": params.strokeWidth,
            "disabled": "disabled",
            "chart": chart_temperature,
            "value": "{y}"
        }

        am4Core.createSeries(data, config)

        // Create legend
        chart_temperature.legend = new am4charts.Legend()

        // Create cursor
        chart_temperature.cursor = new am4charts.XYCursor()
        chart_temperature.cursor.behavior = "panXY"

        // Enable export
        chart_temperature.exporting.menu = new am4core.ExportMenu()
        chart_temperature.exporting.menu.verticalAlign = "bottom";

        // *************************************
        // ******* Create chart instance glukose
        // *************************************

        model = {{ glukose | safe }}
        model['min'] = constants.min_glukose
        model['max'] = constants.max_glukose


        params = {
            "div": "chartdiv_glukose",
            "lang": am4lang_ru_RU,
            "location": 0,
            "distance": 100,
            "y_min": 0,
            "y_max": 20,
            "min": model.min,
            "max": model.max,
            "color": "#a545c7",
            "strokeWidth": strokeWidth,
            "model": model
        }



        chart_glukose = am4core.create(params.div, am4charts.XYChart)
        chart_glukose.language.locale = params.lang
        dateAxis_glukose = chart_glukose.xAxes.push(new am4charts.DateAxis())
        dateAxis_glukose.renderer.grid.template.location = params.location
        dateAxis_glukose.dateFormats.setKey("day", "dd.MM")
        dateAxis_glukose.dateFormats.setKey("week", "dd.MM")
        dateAxis_glukose.dateFormats.setKey("month", "MM.yyyy")



        date_max = new Date(params.model['date_max'].replace(' ', 'T'))
        date_min = new Date(params.model['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart_glukose.events.on("ready", function () {
            dateAxis_glukose.zoomToDates(
                date_min,
                date_max
            );
        });

        yAxis_glukose = chart_glukose.yAxes.push(new am4charts.ValueAxis())
        yAxis_glukose.min = params.y_min
        yAxis_glukose.max = params.y_max
        model = params.model
        data = Aux.dataTransform(model)
        data = data.reverse()
        min = params.min
        max = params.max

        for (key in data) {
            if (data[key]['y'] > max || data[key]['y'] < min) {
                data[key]['color_danger'] = namesConstants.get('color_danger')
                data[key]['disabled'] = false
            } else {
                data[key]['disabled'] = true
            }
        }

        tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}"

        config = {
            "name": model.name,
            "field": "y",
            "dateX": "dates_format",
            "comments": "comments",
            "tooltipText": tooltipText,
            "color": params.color,
            "color_danger": "color_danger",
            "strokeWidth": params.strokeWidth,
            "disabled": "disabled",
            "chart": chart_glukose,
            "value": "{y}"
        }



        am4Core.createSeries(data, config)

        // Create legend
        chart_glukose.legend = new am4charts.Legend()

        // Create cursor
        chart_glukose.cursor = new am4charts.XYCursor()
        chart_glukose.cursor.behavior = "panXY"

        // Enable export
        chart_glukose.exporting.menu = new am4core.ExportMenu()
        chart_glukose.exporting.menu.verticalAlign = "bottom";


        // ************************************
        // ******* Create chart instance weight
        // ************************************

        model = {{ weight | safe }}
        model['min'] = constants.min_weight
        model['max'] = constants.max_weight


        params = {
            "div": "chartdiv_weight",
            "lang": am4lang_ru_RU,
            "location": 0,
            "distance": 100,
            "y_min": 0,
            "y_max": 200,
            "min": model.min,
            "max": model.max,
            "color": "lightgreen",
            "strokeWidth": strokeWidth,
            "comments": model.comments,
            "model": model
        }

        chart_weight = am4core.create(params.div, am4charts.XYChart);
        chart_weight.language.locale = params.lang;
        dateAxis_weight = chart_weight.xAxes.push(new am4charts.DateAxis());
        dateAxis_weight.renderer.grid.template.location = params.location;
        dateAxis_weight.dateFormats.setKey("day", "dd.MM")
        dateAxis_weight.dateFormats.setKey("week", "dd.MM")
        dateAxis_weight.dateFormats.setKey("month", "MM.yyyy")

        date_max = new Date(params.model['date_max'].replace(' ', 'T'))
        date_min = new Date(params.model['date_min'].replace(' ', 'T'));

        // Pre-zoom the chart
        chart_weight.events.on("ready", function () {
            dateAxis_weight.zoomToDates(
                date_min,
                date_max
            );
        });

        yAxis_weight = chart_weight.yAxes.push(new am4charts.ValueAxis());
        yAxis_weight.min = params.y_min;
        yAxis_weight.max = params.y_max;
        model = params.model;
        data = Aux.dataTransform(model);
        data = data.reverse();
        min = params.min;
        max = params.max;

        for (key in data) {
            if (data[key]['y'] > max || data[key]['y'] < min) {
                data[key]['color_danger'] = namesConstants.get('color_danger');
                data[key]['disabled'] = false;
            } else {
                data[key]['disabled'] = true;
            }
        }

        tooltipText = model.name + ": [bold]{y}[normal] | от " + min + " до " + max + " | {tooltip_date}" + "\n {comments}";

        config = {
            "name": model.name,
            "field": "y",
            "dateX": "dates_format",
            "comments": "comments",
            "tooltipText": tooltipText,
            "color": params.color,
            "color_danger": "color_danger",
            "strokeWidth": params.strokeWidth,
            "disabled": "disabled",
            "chart": chart_weight,
            "value": "{y}"
        }

        am4Core.createSeries(data, config);

        // Create legend
        chart_weight.legend = new am4charts.Legend();

        // Create cursor
        chart_weight.cursor = new am4charts.XYCursor();
        chart_weight.cursor.behavior = "panXY"

        // Enable export
        chart_weight.exporting.menu = new am4core.ExportMenu();
        chart_weight.exporting.menu.verticalAlign = "bottom";
    </script>

</body>
</html>